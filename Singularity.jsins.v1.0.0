Bootstrap: docker
From: ubuntu:16.04

%help
fmri_conncalc_JSins

FMRI functional connectivity processing (specific to JS insula study).

TO BUILD
We expect to build from fmri-connectivity/fmri_conncalc_subj directory:
  sudo singularity build sing/fmri_conncalc_JSins.simg sing/Singularity_JSins

TO RUN
Assuming run from fmri-connectivity/fmri_conncalc_subj/sing directory
  singularity run --cleanenv -B INPUTS:/INPUTS,OUTPUTS:/OUTPUTS fmri_conncalc_JSins.simg

INPUTS
In the bound INPUTS directory:

coreg_mat.txt,FILE,INIT_COREG_MAT of MAGM_Coreg_Normalize_v2
y_deffwd.nii.gz,FILE,FWD_DEF of MAGM_Coreg_Normalize_v2
ct1.nii.gz,FILE,COREG_T1 of MAGM_Coreg_Normalize_v2
wgm.nii.gz,FILE,W_GRAY of MAGM_Coreg_Normalize_v2
wcseg.nii.gz,FILE,W_SEG of MAGM_Coreg_Normalize_v2
fmri.nii.gz,FILE,NIFTI resource of fMRI scan
project,FILE,Text file containing project label
subject,FILE,Text file containing subject label
session,FILE,Text file containing session label
scan,FILE,Text file containing scan label

OUTPUTS
fmri_conncalc.pdf,FILE,PDF
FD.txt,FILE,FD
DVARS.txt,FILE,DVARS
badvols.txt,FILE,BADVOLS
confounds_keepgm_noscrub.txt,FILE,CONFOUNDS_KEEPGM_NOSCRUB
connectivity_matrix_R_keepgm_noscrub.csv,FILE,CONNMAT_R_KEEPGM_NOSCRUB
filtered_keepgm_noscrub.nii.gz,FILE,FILTERED_KEEPGM_NOSCRUB
roi_timeseries_keepgm_noscrub.csv,FILE,ROI_DATA_KEEPGM_NOSCRUB
stats_keepgm_noscrub.txt,FILE,STATS_KEEPGM_NOSCRUB
Zmap_keepgm_noscrub.nii.gz,FILE,ZMAP_KEEPGM_NOSCRUB
sZmap_keepgm_noscrub.nii.gz,FILE,SZMAP_KEEPGM_NOSCRUB
confounds_keepgm_scrub.txt,FILE,CONFOUNDS_KEEPGM_SCRUB
connectivity_matrix_R_keepgm_scrub.csv,FILE,CONNMAT_R_KEEPGM_SCRUB
filtered_keepgm_scrub.nii.gz,FILE,FILTERED_KEEPGM_SCRUB
roi_timeseries_keepgm_scrub.csv,FILE,ROI_DATA_KEEPGM_SCRUB
stats_keepgm_scrub.txt,FILE,STATS_KEEPGM_SCRUB
Zmap_keepgm_scrub.nii.gz,FILE,ZMAP_KEEPGM_SCRUB
sZmap_keepgm_scrub.nii.gz,FILE,SZMAP_KEEPGM_SCRUB
confounds_removegm_noscrub.txt,FILE,CONFOUNDS_REMOVEGM_NOSCRUB
connectivity_matrix_R_removegm_noscrub.csv,FILE,CONNMAT_R_REMOVEGM_NOSCRUB
filtered_removegm_noscrub.nii.gz,FILE,FILTERED_REMOVEGM_NOSCRUB
roi_timeseries_removegm_noscrub.csv,FILE,ROI_DATA_REMOVEGM_NOSCRUB
stats_removegm_noscrub.txt,FILE,STATS_REMOVEGM_NOSCRUB
Zmap_removegm_noscrub.nii.gz,FILE,ZMAP_REMOVEGM_NOSCRUB
sZmap_removegm_noscrub.nii.gz,FILE,SZMAP_REMOVEGM_NOSCRUB
confounds_removegm_scrub.txt,FILE,CONFOUNDS_REMOVEGM_SCRUB
connectivity_matrix_R_removegm_scrub.csv,FILE,CONNMAT_R_REMOVEGM_SCRUB
filtered_removegm_scrub.nii.gz,FILE,FILTERED_REMOVEGM_SCRUB
roi_timeseries_removegm_scrub.csv,FILE,ROI_DATA_REMOVEGM_SCRUB
stats_removegm_scrub.txt,FILE,STATS_REMOVEGM_SCRUB
Zmap_removegm_scrub.nii.gz,FILE,ZMAP_REMOVEGM_SCRUB
sZmap_removegm_scrub.nii.gz,FILE,SZMAP_REMOVEGM_SCRUB
wmeanadfunc.nii.gz,FILE,W_FUNC_MEAN
wadfunc.nii.gz,FILE,W_FUNC
rwroi_labels.nii.gz,FILE,ROI_LABELS
rp_adfunc.txt,FILE,REALIGN_PARAMS
roi_snr.nii.gz,FILE,ROI_SNR
roi_info.csv,FILE,ROI_INFO
roi_labels.csv,FILE,ROI_LABEL_INFO
params.csv,FILE,PARAMS

%files
  # Build from fmri-connectivity/fmri_conncalc_subj for this to work 
  matlab/compiled_JSins /code
 
%labels
  Name fmri_conncalc_JSins
  Maintainer baxter.rogers@vanderbilt.edu

%post
  apt-get update
  apt-get install -y wget unzip zip xvfb ghostscript openjdk-8-jre imagemagick
  
  # Fix imagemagick policy to allow PDF output. See https://usn.ubuntu.com/3785-1/
  sed -i 's/rights="none" pattern="PDF"/rights="read | write" pattern="PDF"/' \
    /etc/ImageMagick-6/policy.xml
  
  # Download the Matlab Compiled Runtime installer, install, clean up
  mkdir /MCR
  wget -P/MCR http://ssd.mathworks.com/supportfiles/downloads/R2017a/deployment_files/R2017a/installers/glnxa64/MCR_R2017a_glnxa64_installer.zip
  unzip /MCR/MCR_R2017a_glnxa64_installer.zip -d /MCR/MCR_R2017a_glnxa64_installer
  /MCR/MCR_R2017a_glnxa64_installer/install -mode silent -agreeToLicense yes
  rm -fr /MCR/MCR_R2017a_glnxa64_installer /MCR/MCR_R2017a_glnxa64_installer.zip
  rmdir /MCR

  # Create input/output directories for binding
  mkdir /INPUTS && mkdir /OUTPUTS

%environment
  # Set Matlab library path
  LD_LIBRARY_PATH=/usr/local/MATLAB/MATLAB_Runtime/v92/runtime/glnxa64:/usr/local/MATLAB/MATLAB_Runtime/v92/bin/glnxa64:/usr/local/MATLAB/MATLAB_Runtime/v92/sys/os/glnxa64:${LD_LIBRARY_PATH}
  export LD_LIBRARY_PATH

%runscript
  cd /code && \
    xvfb-run --server-num=$(($$ + 99)) \
    --server-args='-screen 0 1600x1200x24 -ac +extension GLX' \
    sh run_fmri_conncalc_JSins.sh \
    /usr/local/MATLAB/MATLAB_Runtime/v92
